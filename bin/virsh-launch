#!/bin/sh

# bibitem{ADN LAB'S BLOG}t_oooka,ADN LAB'S BLOG, http://lab.adn-mobasia.net/?p=471

# usege: virsh-launch <domain_name> <IP address> 
# dependency: libguestfs libguestfs-tools libguestfs-tools

work_dir=/tmp/clone-guest

cmd_awk=/bin/awk
cmd_cat=/bin/cat
cmd_cut=/bin/cut
cmd_grep=/bin/grep
cmd_mkdir=/bin/mkdir
cmd_sed=/bin/sed
cmd_uuidgen=/usr/bin/uuidgen
cmd_virsh=/usr/bin/virsh
cmd_virt_cat=/usr/bin/virt-cat
cmd_virt_clone=/usr/bin/virt-clone
cmd_virt_copy_in=/usr/bin/virt-copy-in
domain_image_dir=/var/lib/libvirt/images

# ---
clone_domain_name=$1
clone_ipaddr=$2
# ---

# ---
##################################################################################################
### CHANGE VARIABLES FOR YOUR ENVIRONMENT                                                        #
##################################################################################################
source_bridge=network01                     # the cloned VM will connect this bridge(or network).#
original_domain_name=template_centos        # the name of template-VM                            #
original_fqdn=localhost.localdomain         # the hostname of template-VM                        #
original_ipaddr=192.168.100.2               # the IP address of template-VM                      #
clone_fqdn=${clone_domain_name}.example.com # the hostname of  cloned-VM                         #
#################################################################################################
# ---

clone_domain_image_path=$domain_image_dir/$clone_domain_name.img

# --------------------------------------------------
# pre process.
# --------------------------------------------------

if [ "$clone_domain_name" = "" -o "$clone_ipaddr" = "" ] ; then
    echo "Usage clone-guest.sh <domain_name> <ipaddr>"
    exit 0
fi

[ ! -e $work_dir ] && $cmd_mkdir -p $work_dir

# --------------------------------------------------
# main process.
# --------------------------------------------------
$cmd_virt_clone                                               \
--original $original_domain_name                            \
--name $clone_domain_name                                   \
--file $clone_domain_image_path

# ----- /etc/hosts -----
$cmd_virt_cat -d $original_domain_name /etc/hosts             \
> $work_dir/hosts.org
$cmd_cat $work_dir/hosts.org                                  \
| $cmd_sed -e "s/$original_fqdn/$clone_fqdn/"                  \
> $work_dir/hosts
$cmd_virt_copy_in -d $clone_domain_name $work_dir/hosts /etc/

# ----- /etc/sysconfig/network ------
$cmd_virt_cat -d $original_domain_name /etc/sysconfig/network \
> $work_dir/network.org
$cmd_cat $work_dir/network.org                                \
| $cmd_sed -e "s/$original_fqdn/$clone_fqdn/"                  \
> $work_dir/network
$cmd_virt_copy_in -d $clone_domain_name $work_dir/network /etc/sysconfig

# ----- /etc/sysconfig/network-scripts/ifcfg-eth0 ------
original_mac_addr=$(                                          \
$cmd_virsh domiflist $original_domain_name                    \
| $cmd_grep $source_bridge                                    \
| $cmd_awk '{print $5}'                                       \
)
clone_mac_addr=$(                                             \
$cmd_virsh domiflist $clone_domain_name                       \
| $cmd_grep $source_bridge                                    \
| $cmd_awk '{print $5}'                                       \
)

original_nic_uuid=$(                                          \
$cmd_cat $work_dir/ifcfg-eth0.org                             \
| $cmd_grep -i uuid                                           \
| $cmd_cut -d'=' -f2                                          \
| $cmd_sed 's/"//g'                                           \
)
clone_nic_uuid=$($cmd_uuidgen)

$cmd_virt_cat -d $original_domain_name                        \
/etc/sysconfig/network-scripts/ifcfg-eth0                   \
> $work_dir/ifcfg-eth0.org
$cmd_cat $work_dir/ifcfg-eth0.org                             \
| $cmd_sed -e "s/$original_mac_addr/$clone_mac_addr/i"        \
-e "s/$original_nic_uuid/$clone_nic_uuid/"                   \
-e "s/$original_ipaddr/$clone_ipaddr/"                       \
> $work_dir/ifcfg-eth0
$cmd_virt_copy_in -d $clone_domain_name                       \
$work_dir/ifcfg-eth0                                        \
/etc/sysconfig/network-scripts/

# ----- /etc/udev/rules.d/70-persistent-net.rules -----
$cmd_virt_cat -d $original_domain_name                        \
/etc/udev/rules.d/70-persistent-net.rules                   \
> $work_dir/70-persistent-net.rules.org
$cmd_cat $work_dir/70-persistent-net.rules.org                \
| $cmd_sed -e "s/$original_mac_addr/$clone_mac_addr/i"         \
> $work_dir/70-persistent-net.rules
$cmd_virt_copy_in -d $clone_domain_name                       \
$work_dir/70-persistent-net.rules                           \
/etc/udev/rules.d/

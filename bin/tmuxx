#!/bin/bash

is_exists() {
    which "$1" >/dev/null 2>&1 ; return $?
}
has() {
    is_exists "$@"
}
is_ssh_running() {
    [ ! -z "$SSH_CLIENT" ]
}
is_screen_running() {
    [ ! -z "$STY" ]
}
is_tmux_runnning() {
    [ ! -z "$TMUX" ]
}
is_screen_or_tmux_running() {
    is_screen_running || is_tmux_runnning
}

if is_screen_or_tmux_running; then
    if is_tmux_runnning; then
        if has "cowsay"; then
            if [[ $(( RANDOM % 5 )) == 1 ]]; then
                cowsay -f ghostbusters "G,g,g,ghostbusters!!!"
                echo ""
            fi
        else
            echo ' _____ __  __ _   ___  __ '
            echo '|_   _|  \/  | | | \ \/ / '
            echo '  | | | |\/| | | | |\  /  '
            echo '  | | | |  | | |_| |/  \  '
            echo '  |_| |_|  |_|\___//_/\_\  has been already running'
        fi
        export DISPLAY="$TMUX"
    elif is_screen_running; then
        # For GNU screen
        :
    fi
else
    #if shell_has_started_interactively && ! is_ssh_running; then
    if ! has "tmux"; then
        echo "tmux not found" 1>&2
        exit 1
    fi

    if tmux has-session >/dev/null 2>&1 && tmux list-sessions | grep -qE '.*]$'; then
        # detached session exists
        tmux list-sessions | perl -pe 's/(^.*?):/\033[31m$1:\033[m/'
        echo -n "Tmux: attach? (y/N/num/session-name) "
        read
        if [[ "$REPLY" =~ ^[Yy]$ ]] || [[ "$REPLY" == '' ]]; then
            tmux attach-session
            if [ $? -eq 0 ]; then
                echo "$(tmux -V) attached session"
                exit
            fi
        elif [[ "$REPLY" =~ ^[nN]$ ]] ; then
            echo "tmux-attach canceled"
        elif tmux list-sessions | grep -q "^$REPLY"; then
            tmux attach -t "$REPLY"
            if [ $? -eq 0 ]; then
                echo "$(tmux -V) attached session"
                exit
            fi
        else
            tmux new-session -s "$REPLY" && echo "tmux created new session"
            exit
        fi
    fi

    echo -n "Tmux: new-session? (y/N/session-name) "
    read
    if [[ "$REPLY" =~ ^[Yy]$ ]] || [[ "$REPLY" == '' ]]; then
        tmux new-session && echo "tmux created new session"
    elif [[ "$REPLY" =~ ^[nN]$ ]] ; then
        echo "tmux-new canceled"
        exit
    else
        tmux new-session -s "$REPLY" && echo "tmux created new session"
    fi
fi
